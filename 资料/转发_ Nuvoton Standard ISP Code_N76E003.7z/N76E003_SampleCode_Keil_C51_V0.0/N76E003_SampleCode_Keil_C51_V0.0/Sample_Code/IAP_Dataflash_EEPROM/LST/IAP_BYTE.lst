C51 COMPILER V9.00   IAP_BYTE                                                              03/14/2017 17:41:12 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE IAP_BYTE
OBJECT MODULE PLACED IN .\Output\IAP_BYTE.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Code\IAP_BYTE.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\..\Include) DEFINE(FO
                    -SC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\IAP_BYTE.lst) TABS(2) OBJECT(.\Output\IAP_BYTE.obj)

line level    source

   1          /*--------------------------------------------------------------------------------------------------------
             --*/
   2          /*                                                                                                        
             - */
   3          /* Copyright(c) 2016 Nuvoton Technology Corp. All rights reserved.                                        
             - */
   4          /*                                                                                                        
             - */
   5          /*--------------------------------------------------------------------------------------------------------
             --*/
   6          
   7          //********************************************************************************************************
             -***
   8          //  Nuvoton Technoledge Corp. 
   9          //  Website: http://www.nuvoton.com
  10          //  E-Mail : MicroC-8bit@nuvoton.com
  11          //  Date   : Apr/21/2016
  12          //********************************************************************************************************
             -***
  13          
  14          //********************************************************************************************************
             -***
  15          //  File Function: N76E003 APROM program DATAFLASH as EEPROM way 
  16          //********************************************************************************************************
             -***
  17          #include <stdio.h>
  18          #include "N76E003.h"
  19          #include "Define.h"
  20          #include "Common.h"
  21          #include "Delay.h"
  22          #include "SFR_Macro.h"
  23          #include "Function_define.h"
  24          
  25          bit BIT_TMP;
  26          
  27          //-------------------------------------------------------------------------
  28          UINT8 read_APROM_BYTE(UINT16 code *u16_addr)
  29          {
  30   1        UINT8 rdata;
  31   1        rdata = *u16_addr>>8;
  32   1        return rdata;
  33   1      }
  34          //-------------------------------------------------------------------------
  35          
  36          
  37          /*********************************************************************************************************
             -********
  38          write_DATAFLASH_BYTE :
  39          user can copy all this subroutine into project, then call this function in main.
  40          **********************************************************************************************************
             -********/    
  41          void write_DATAFLASH_BYTE(UINT16 u16_addr,UINT8 u8_data)
  42          {
  43   1        UINT8 looptmp=0,u8_addrl_r;
C51 COMPILER V9.00   IAP_BYTE                                                              03/14/2017 17:41:12 PAGE 2   

  44   1        unsigned char code *cd_longaddr;
  45   1        unsigned char xdata *xd_tmp;
  46   1        
  47   1      //Check page start address
  48   1        u8_addrl_r = u16_addr;
  49   1        if (u8_addrl_r<0x80)
  50   1        {
  51   2          u8_addrl_r = 0;
  52   2        }
  53   1        else 
  54   1        {
  55   2          u8_addrl_r = 0x80;
  56   2        }
  57   1      //Save APROM data to XRAM
  58   1        xd_tmp = 0x80;
  59   1        cd_longaddr = (u16_addr&0xff00)+u8_addrl_r; 
  60   1        while (xd_tmp !=0x100)
  61   1        {
  62   2          *xd_tmp = *cd_longaddr;
  63   2          looptmp++;
  64   2          xd_tmp++;
  65   2          cd_longaddr++;
  66   2        }
  67   1      // Modify customer data in XRAM
  68   1        u8_addrl_r = u16_addr;
  69   1        if (u8_addrl_r<0x80)
  70   1        {
  71   2          xd_tmp = u8_addrl_r+0x80;
  72   2        }
  73   1        else
  74   1        {
  75   2          xd_tmp = u8_addrl_r+0;
  76   2        }
  77   1        *xd_tmp = u8_data;
  78   1      //Erase APROM DATAFLASH page
  79   1          IAPAL = u16_addr;
  80   1          IAPAH = u16_addr>>8;
  81   1          IAPFD = 0xFF;
  82   1          set_IAPEN; 
  83   1          set_APUEN;
  84   1          IAPCN = 0x22;     
  85   1          set_IAPGO; 
  86   1      //Save changed RAM data to APROM DATAFLASH
  87   1        u8_addrl_r = u16_addr;
  88   1        if (u8_addrl_r<0x80)
  89   1        {
  90   2          u8_addrl_r =0;
  91   2        }
  92   1        else
  93   1        {
  94   2          u8_addrl_r = 0x80;
  95   2        }
  96   1          xd_tmp = 0x80;
  97   1          IAPAL = u8_addrl_r;
  98   1          IAPAH = u16_addr>>8;
  99   1          set_IAPEN; 
 100   1          set_APUEN;
 101   1          IAPCN = 0x21;
 102   1          while (xd_tmp !=0xFF)
 103   1          {
 104   2            IAPFD = *xd_tmp;
 105   2            set_IAPGO;
C51 COMPILER V9.00   IAP_BYTE                                                              03/14/2017 17:41:12 PAGE 3   

 106   2            IAPAL++;
 107   2            xd_tmp++;
 108   2          }
 109   1          clr_APUEN;
 110   1          clr_IAPEN;
 111   1      } 
 112          /*********************************************************************************************************
             -*********/    
 113          
 114          
 115          void main (void) 
 116          {
 117   1          UINT8 datatemp;
 118   1      /* -------------------------------------------------------------------------*/
 119   1      /*  Dataflash use APROM area                                                */
 120   1      /*  APROM 0x3800~0x38FF demo as dataflash                                   */
 121   1      /* Please use Memory window key in C:0x3800 to check earse result           */        
 122   1      /* -------------------------------------------------------------------------*/
 123   1        
 124   1      //call write byte 
 125   1          write_DATAFLASH_BYTE (0x0200,0x55);
 126   1          write_DATAFLASH_BYTE (0x3882,0x56);
 127   1          write_DATAFLASH_BYTE (0x3855,0xaa);
 128   1          write_DATAFLASH_BYTE (0x3856,0x66);
 129   1      //call read byte
 130   1          datatemp = read_APROM_BYTE(0x0200);
 131   1          while(1);
 132   1      }
 133          //--------------------------------------------------------------------------------------------------------
             ----


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    372    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
